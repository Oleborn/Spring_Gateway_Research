############################################################
# HTTP-сервер MVC Gateway
############################################################

server:
  # Порт, на котором слушает MVC Gateway.
  # Все внешние HTTP-запросы приходят именно сюда.
  port: 8090

  # Настройки servlet-контейнера Tomcat.
  # Они КРИТИЧНЫ для демонстрации производительности MVC Gateway.
  tomcat:

    # Максимальное количество рабочих потоков.
    #
    # Каждый HTTP-запрос в MVC Gateway
    # занимает ОДИН поток на всё время обработки.
    #
    # Ограничение пула позволяет:
    # - быстрее увидеть деградацию под нагрузкой;
    # - наглядно показать thread starvation;
    # - сравнить с WebFlux Gateway.
    threads:
      max: 20

      # Минимальное количество потоков,
      # которые Tomcat держит заранее.
      #
      # Это снижает latency при низкой нагрузке,
      # но не спасает при saturation.
      min-spare: 10


############################################################
# Spring Cloud Gateway — MVC конфигурация
############################################################

spring:
  cloud:
    gateway:

      # Блок MVC Gateway.
      #
      # ВАЖНО:
      # - это НЕ WebFlux Gateway;
      # - это декларативный routing поверх servlet-стека;
      # - Java DSL здесь НЕ используется.
      mvc:

        ####################################################
        # ROUTES — маршруты MVC Gateway
        ####################################################
        routes:

          ##################################################
          # ROUTE: only-b
          #
          # Минимальный маршрут для демонстрации
          # работы MVC Gateway.
          ##################################################
          - id: only-b

            # URI backend-сервиса.
            #
            # Gateway проксирует запросы
            # на сервис B, не зная его логики.
            uri: http://localhost:8082

            # Predicate — условие выбора маршрута.
            #
            # Маршрут срабатывает,
            # если путь начинается с /b/
            predicates:
              - Path=/b/**

            # Filters — инфраструктурные операции,
            # применяемые ПОСЛЕ выбора маршрута.
            filters:

              # StripPrefix=1 удаляет первый сегмент пути.
              #
              # Пример:
              #   /b/ping  →  /ping
              #
              # Backend не знает,
              # что запрос пришёл через Gateway.
              - StripPrefix=1

              # Добавляем HTTP-заголовок,
              # явно маркирующий тип Gateway.
              #
              # Используется ТОЛЬКО для демонстрации
              # и удобства диагностики.
              #
              # Позволяет:
              # - отличать MVC Gateway от WebFlux Gateway;
              # - видеть путь запроса в backend-логах.
              - AddRequestHeader=X-Gateway-Type,MVC


  ############################################################
  # HTTP-клиент MVC Gateway
  ############################################################

  # Настройки HTTP-клиента,
  # используемого MVC Gateway
  # для обращения к backend-сервисам.
  http:
    client:

      # Таймаут установления соединения (в миллисекундах).
      #
      # Если backend недоступен или медленно отвечает,
      # servlet-поток Gateway БЛОКИРУЕТСЯ,
      # ожидая соединения.
      connect-timeout: 1000

      # Таймаут ожидания ответа от backend.
      #
      # ВАЖНО:
      # - поток Gateway удерживается ВСЁ это время;
      # - при высокой нагрузке это приводит
      #   к истощению пула потоков.
      read-timeout: 2000


############################################################
# ЛОГИРОВАНИЕ
############################################################

logging:
  level:

    # Основные логи Spring Cloud Gateway.
    #
    # Показывают:
    # - выбор маршрута;
    # - применение фильтров;
    # - проксирование запросов.
    org.springframework.cloud.gateway: DEBUG

    # Логи DispatcherServlet.
    #
    # Подчёркивают, что MVC Gateway работает
    # через servlet-пайплайн,
    # а не через реактивный event-loop.
    org.springframework.web.servlet.DispatcherServlet: DEBUG

