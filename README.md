# Spring Cloud Gateway Research

## Описание Проекта

Этот репозиторий представляет собой комплексный исследовательский проект, предназначенный для демонстрации ключевых архитектурных принципов и функциональных возможностей **Spring Cloud Gateway (SCG)**.

Проект структурирован как многомодульное приложение, которое наглядно показывает, как SCG, построенный на реактивном стеке **Spring WebFlux**, решает инфраструктурные задачи в микросервисной архитектуре. Особое внимание уделено сравнению реактивного подхода (WebFlux) с традиционным подходом (WebMVC).

## Архитектура и Структура

Проект состоит из четырех основных модулей:

| Модуль | Стек | Роль | Описание |
| :--- | :--- | :--- | :--- |
| `gateway-webflux` | Spring WebFlux | **Основной Gateway** | Высокопроизводительный, неблокирующий API Gateway. Содержит все демонстрационные шаги (Steps) по настройке маршрутов, фильтров, устойчивости и безопасности. |
| `gateway-webmvc` | Spring WebMVC | **Сравнительный Gateway** | Традиционный, блокирующий API Gateway на основе Servlet. Используется для демонстрации ограничений и отличий от реактивного подхода. |
| `service-a` | Spring Boot | **Backend Service A** | Простой микросервис, выступающий в роли целевого бэкенда для маршрутизации. |
| `service-b` | Spring Boot | **Backend Service B** | Второй микросервис, используемый для демонстрации балансировки нагрузки и динамической маршрутизации. |

## Ключевые Демонстрации (Steps)

Модуль `gateway-webflux` содержит серию последовательных шагов, каждый из которых демонстрирует отдельный архитектурный аспект SCG. Для активации каждого шага используется соответствующий **Spring Profile** (`step1`, `step2`, ..., `step8`).

| Шаг | Файл Конфигурации | Демонстрируемый Принцип | Ключевые Особенности |
| :--- | :--- | :--- | :--- |
| **Step 1** | `Step1Routes.java` | **Базовая Маршрутизация** | Простейший HTTP-прокси. Демонстрация декларативной модели `Route` без `Predicate` и `Filter`. |
| **Step 3** | `Step3RoutesWithFilter.java` | **Gateway Filters** | Применение фильтров, специфичных для конкретного маршрута (например, `AddRequestHeader`, `StripPrefix`). |
| **Step 5** | `Step5Routes.java` + `Step5ShortCircuitFilter.java` | **Short-Circuit** | Механизм осознанного и управляемого прерывания Pipeline. Демонстрация того, как фильтр может остановить обработку запроса до вызова бэкенда. |
| **Step 6** | `Step6RoutesWithRetray.java` | **Устойчивость (Resilience)** | Настройка политики **Retry** (повторных попыток) для повышения устойчивости к временным ошибкам бэкенда. |
| **Step 7** | `Step7RoutesWithMetadata.java` + `Step7MetadataAwareFilter.java` | **Метаданные Маршрута** | Использование метаданных (`metadata`) для передачи конфигурации от Route к фильтрам. |
| **Step 8** | `Step8Routes.java` + `Step8IpValidationFilter.java` | **Инфраструктурная Валидация** | Реализация **GlobalFilter** для централизованной IP-валидации. Демонстрация правильного определения IP клиента (`X-Forwarded-For`, `X-Real-IP`). |

## Дополнительные Материалы

В корне репозитория находится файл **`GUIDE.md`**, который содержит подробное архитектурное руководство по Spring Cloud Gateway, объясняющее такие концепции, как:

*   Pipeline обработки запроса.
*   Различия между `Predicate`, `GatewayFilter` и `GlobalFilter`.
*   Принципы `Short-circuit` и `Order` фильтров.
*   Разделение ответственности между Gateway и Backend.

## Как Запустить Проект

### 1. Предварительные Требования

*   Java 17+
*   Apache Maven 3.x

### 2. Сборка Проекта

Склонируйте репозиторий и соберите все модули с помощью Maven:

```bash
git clone https://github.com/Oleborn/Spring_Gateway_Research.git
cd Spring_Gateway_Research
mvn clean install
```

### 3. Запуск Бэкенд-Сервисов

Запустите целевые сервисы A и B. Они должны быть запущены первыми, чтобы Gateway мог к ним обращаться.

```bash
# Запуск Service A (порт 8081)
java -jar service-a/target/service-a-*.jar &

# Запуск Service B (порт 8082)
java -jar service-b/target/service-b-*.jar &
```

### 4. Запуск Gateway (WebFlux)

Запустите основной Gateway, активируя нужный демонстрационный профиль.

**Пример: Запуск Step 8 (IP-валидация)**

```bash
# Запуск Gateway на порту 8080 с активным профилем "step8"
java -jar gateway-webflux/target/gateway-webflux-*.jar --spring.profiles.active=step8
```

### 5. Тестирование

После запуска Gateway на порту `8080` вы можете протестировать функциональность с помощью `curl` или Postman.

#### Пример 1: Тестирование Step 1 (Базовый прокси)

Запустите с профилем `step1`.

```bash
# Запрос к Service A через Gateway
curl http://localhost:8080/a/ping
# Ожидаемый ответ: "Hello from Service A"
```

#### Пример 2: Тестирование Step 5 (Short-Circuit)

Запустите с профилем `step5`. Фильтр `Step5ShortCircuitFilter` блокирует запрос, если присутствует заголовок `X-Deny: true`.

```bash
# Запрос, который будет остановлен на уровне Gateway
curl -i -H "X-Deny: true" http://localhost:8080/a/ping
# Ожидаемый HTTP-статус: 403 Forbidden
```

#### Пример 3: Тестирование Step 8 (IP-валидация)

Запустите с профилем `step8`. Фильтр `Step8IpValidationFilter` разрешает доступ только с определенных IP-адресов (включая `127.0.0.1`).

```bash
# Запрос с разрешенного IP (localhost)
curl http://localhost:8080/a/ping
# Ожидаемый ответ: "Hello from Service A"
```

## Сравнение WebFlux vs. WebMVC

Модуль `gateway-webmvc` включен для демонстрации того, что Spring Cloud Gateway может работать на традиционном Servlet-стеке. Однако, **WebFlux Gateway** является предпочтительным и рекомендуемым выбором для высоконагруженных систем благодаря своей неблокирующей, реактивной архитектуре.

| Характеристика | `gateway-webflux` (Рекомендуется) | `gateway-webmvc` (Компромисс) |
| :--- | :--- | :--- |
| **Стек** | Реактивный (Project Reactor) | Традиционный (Servlet) |
| **Производительность** | Высокая (Event-Loop) | Умеренная (Блокирующая) |
| **Конфигурация** | Java DSL и YAML | Только YAML/Properties |
| **Использование** | Основной Entry Point для микросервисов | Миграционные сценарии, низкая нагрузка |

---

## По всем вопросам пишите:

**@Oleborn**
